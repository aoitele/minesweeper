<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
 
    <style>
      #app{
          position:fixed;
          top:5%;
          left:5%;
          transform: transrate(-50%, -50%);
      };
     
      .row{
        width: 30px;
        height: 30px;
        background-color: aqua;
      }

      .block{
          float:left;
          width: 20px;
          height: 20px;
          padding: 1px;
          border: 1px solid grey;
          background-color: rgb(219, 215, 215);
      };
      </style>
 </head>

<body>
<div id="app"></div>
<div id="user">player:</div>
<div id="reset">
  <button>reset</button>
</div>



<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<script>

// 変数
let rows=0; //盤面の列数


// アクセス時：ユーザー登録の有無を確認する
const user = localStorage.getItem("user");
    if(user == null){
      $('#app').append(`
        <p>ユーザー登録を行なってください</p> 
         <div id="modal-content">
            <form id="username">
              <input id="name" type="text" name="name" placeholder="Enter your name">
              <input id=send type="button" name="send" value="登録">
            </form>
          </div>
      `
      );
      $('#send').on("click",function(){
        let name = $('#name').val();
        localStorage.setItem("user", name);
        console.log(name+'を登録しました');
        $('#name').val("");
        location.reload();
      });
    }else {
      console.log("ユーザーは登録済み");
      gamePlaying();
    }

// 盤面生成
const render = (board) =>{
    // DOMを破棄して再構築
    $('#app').empty();
    let html ="";
    let count =0; //ブロックカウント用の変数
    rows =0; //列カウント用の変数
      board.forEach(row => {
          html += `<div class="row">`
              row.forEach(block =>{
                  html += `<a class="block">`
                  html += `</a>`
                  count++;
              }),
          html += `</div>`
      });
    $('#app').append(html);
    rows = Math.sqrt(count); //盤面の列数(および行数)を算出
    // console.log(rows+"列ある盤面です");
    // console.log("Playing...");
};

// ゲーム進行中(0.5秒ごとに盤面を更新していく)
async function gamePlaying(){
      await setInterval(() => {
          $.getJSON('/board', render);
      },1000);
};

// ゲームリセット時
function gameReset(){
  $('#reset').on('click', function(){
    alert("中断しました");
    location.reload();
  });
};

point=[];

// 以下、テストスクリプト
function waitOpen(){
  $(document).on("click", ".block", function(){
      return new Promise((resolve) => {
          console.log("クリックしました");
          const num = $('.block').index(this);
          
          // 縦と横のポジションを算出する
          row = Math.floor(num/rows) //行数
          column = Math.round(num - rows*row) //列数
          console.log(row+"行/"+column+"列を開きました");
          // 配列に保存
          point.push({"x":row, "y":column});
          console.log(point)

          let i = 0;
          // const countUp = setInterval(function(){
          //     console.log(i++);
          //     if(i>3)
          //     clearInterval(countUp);
          // },1000);
        });
    });
}
waitOpen();

// 盤面オープン
function getPoint(rows){
    // クリックしたblockのインデックスを取得する   
    $(document).on("click", ".block", function(){
          console.log('クリックしました')
          num = $('.block').index(this);
          // 縦と横のポジションを算出する
          row = Math.floor(num/rows) //行数
          column = Math.round(num - rows*row) //列数
          console.log(row+"行/"+column+"列を開きました");
          // 配列に保存
          point.push({"x":row, "y":column});
          console.log(point)
    });
};

function Send_board(width){
  // rowとcolumnを代入
  $.getJSON('/board', {
  x: row,
  y: column,
  user: user
  }, render);
};



</script>
</body>

<style>
.block:hover {/*ブロックを選択するとき*/
    background-color: antiquewhite;
};
</style>
<style>
.block:active {/*ブロックを押したとき*/
    -ms-transform: translateY(1px);
    -webkit-transform: translateY(1px);
    transform: translateY(1px);
    border-bottom: none;
};
</style>

</html>


